---
title: 'Linking stormwater control performance to stream ecosystem outcomes: incorporating performance metrics into effective imperviousness'
subtitle: 'Supplementary material S1, S2, S3'
author: 'Christopher J. Walsh, Matthew J. Burns, Tim D. Fletcher, Darren G. Bos, Peter Poelsma, Joshphar Kunapo and Sam J. Imberger'
date: 'School of Ecosystem and Forest Sciences, The University of Melbourne, 500 Yarra Boulevard, Burnley Victoria 3121, Australia '
output: 
  officedown::rdocx_document:
     reference_docx: officedown_template.docx
csl: water-resources-research.csl
bibliography: references.bib
---

```{r load_data, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "pdf", message=FALSE) #,dpi = 200 
source("code/BACRIfunctions.R")  
# also loads required packages(scales, dplyr, lubridate, sf, here, RPostgreSQL,
#                              mcr, RColorBrewer, data.table, RMySQL,"DiagrammeR")
source("code/download.OSF.file.R")
# also loads required packages (httr rjson, here)
source("load_ld_scms_tables.R")
# this script downloads data files from the OSF repository to the local directory
fig_no <- 1
```

## Introduction  

This supplementary information describes detailed methods used for estimating stormwater control performance and effective imperviousness, using a long-term catchment-scale experiment in Melbourne, Australia.  

The data used in the paper were structured as a postgreSQL database. The database's constituent tables are stored in an Open Science Framework repository [@walsh_etal_2021; (https://osf.io/57azq/)]. Spatial tables are stored in the spatial_data component of the repository, and non-spatial tables are stored in the linked data directory of the github repository https://github.com/cjbwalsh/lsc_dbs_scms.  The code in this document assumes it is running from a clone of that repository.

S1 describes the derivation and formulation of the stream stormwater impact metric and its sub-metrics in detail.  

S2 describes the methods to estimate imperviousness in the eleven study catchments. 

S3 describes compilation of specification data for stormwater control measures (SCMs) that were implemented in the Little Stringybark Creek and Dobsons Creek catchments. 

### S1. Derivation and Formulaton of the stream stormwater impact metric, S

The stream stormwater impact metric, *S*, estimates the extent to which an SCM approximates uncontrolled stormwater flows (at its maximum value, 1)
and the extent to which it mimics the catchment hydrology and water quality of appropriate reference streams that support good ecological condition (at its minimum value, 0).  It is the mean of four sub-metrics of different aspects of hydrology that can be addressed through SCM design and that have been posited as the primary drivers of stream degradation by urban stormwater runoff [@fletcher_etal_2011; @walsh_etal_2015; @walsh_etal_2016a].  To calculate each sub-metric, a hydrologic index (*I*) for the impervious area draining to the SCM is modelled (using an average year of rainfall data, in this case 1965-1966) in three potential states:  

- *u*: the impervious area conventionally drained with no SCM;  

- *m*: the impervious area draining to the SCM, modelled based on its specifications;  

- *n*: the area covered by impervious surfaces in its pre-urban state, inferred from the runoff behaviour of forested reference catchments  

Within bounds described below, each sub-metric is the ratio of the divergence of *I* from the pre-urban state with the SCM in place and the divergence of *I* from the pre-urban state if the SCM was absent, thus scaling the effect of the SCM between best case (target or reference condition) and worst case (no stormwater control). Thus:


$$
\begin{aligned}
S_I = \frac{I_m - I_n}{I_u - I_n}
\end{aligned}
$$
where $S_I$ is the sub-metric of *S* based on the hydrologic index *I*, and the three values of *I* denoted by subscripts for three potential states as described above.  Each of the four sub-metrics assess performance against a design objective:  

1. The runoff frequency sub-metric, $S_R$, assesses performance against a design objective to reduce the frequency and magnitude of polluted high flows from impervious surfaces by ensuring that SCMs have sufficient retention capacity to avoid overflow of untreated water in âˆ¼95% of rain events [@walsh_etal_2009]. We used a slightly different calculation of $S_R$ from Walsh *et al.* [-@walsh_etal_2009; -@walsh_etal_2015].  The original calculation counted overflow days binarily, so that an overflow of a small fraction of a rain event was treated equally to an overflow of an entire rain event.  The new formulation weights each overflow day by the proportion of impervious runoff captured by the SCM on that day.  

$$
\begin{aligned}
S_{R} = max(\frac{R_m - R_n}{R_u - R_n}, 0)
\end{aligned}
$$
  
where *S* is the number of overflow days in an average year, with subscripts as described above.  $S_m$ was calculated as $\Sigma_i^n\frac{Vo_i}{Vu_i}$, where $Vo_i$ is the volume of overflow from the SCM on day *i*, and $Vu_i$ is the volume of impervious runoff generated by the impervious surfaces draining to the SCM on day *i*.  If the SCM overflows less frequently than the frequency of overland flow inferred for reference catchments, $S_R$ is zero.

2. The filtered flow volume sub-metric, $S_F$, assesses performance against a design objective to restore base flows lost by the construction of impervious surfaces [@hamel_etal_2013], calculated as:  

$$
\begin{aligned}
if(F_m < F_{forest}),\:S_{F} = \frac{F_m}{F_{forest}}
\end{aligned}
$$
$$
\begin{aligned}
if(F_m > F_{pasture}),\:S_{F} = min(\frac{F_m-F_{pasture}}{F_{forest}},1)
\end{aligned}
$$
$$
\begin{aligned}
else,\:S_{F} =  0 
\end{aligned}
$$

Where $F_m$ is the filtered volume through the SCM, and $F_{pasture}$ and $F_{forest}$ are volumes inferred to be pre-urban baseflow volumes for pasture and forest land cover [@zhang_etal_2001].  These equations do not include $F_u$, which is zero because impervious surfaces prevent infiltration.

3. The water quality sub-metric, $S_W$, assesses performance against a design objective to ensure that median concentration of primary pollutants (Total P, TP; Total N, TN; and Total Suspended Solids, TSS) flowing out of the SCM meet appropriate water quality objectives for stream protection. It was calculated as the mean of three sub-sub-metrics, calculate for each pollutant as: 

$$
\begin{aligned}
S_W = max(\frac{[X]_m - [X]_n}{[X]_u - [X]_n}),0) 
\end{aligned}
$$
where $[X]$ is the median concentration of total phosphorus (TP), total nitrogen (TN) or total suspended solids (TSS), with subscripts as described above. 
$[X]_u$ is the median concentration in untreated urban stormwater as assumed by a standard stormwater model [@ewater_2013; @duncan_1999: 0.35, 2.2 and 120 mg/L for TP, TN and TSS respectively].  $[X]_m$ is the median concentration of combined outflows and overflows from the SCM, assuming no treatment for overflows, and set reductions in median concentrations for filtration systems of differing specifications (https://urbanstreams.net/lsc/EBcalctech.html). $[X]_n$, target concentrations, were derived primarily from the median concentrations observed in reference streams (C J Walsh, unpublished data):  
 
- 20 mg/L TSS;  

- median concentration in reference streams was 0.03 mg/L TP, but $[TP]_n$ was set at 0.05 mg/L, the minimum median concentration achievable by biofiltration systems [@bratieres_etal_2008; @hatt_etal_2009];  

- median concentration in the reference stream with fewest septic tanks was 0.8 mg/L TN, but $[TN]_n$ was set at 0.6 mg/L because reference sites in our study area are likely to have elevated TN concentrations, and 0.6 mg/L was achievable by biofiltration systems [@bratieres_etal_2008; @hatt_etal_2009]).

4. The volume-reduction sub-metric, $S_V$, assesses performance against a design objective to ensure that total runoff volume approximates the volume of rain falling on the impervious area that would have become streamflow in its pre-urban state.  


$$
\begin{aligned}
S_V = max(\frac{V_m - V_n}{V_u - V_n}, 0)
\end{aligned}
$$
where *V* is the total runoff volume, and following the conventions above; *V*$_m$ is the volume of impervious runoff passing through the SCM that is likely to become streamflow (overflow, exfiltration, and any flow through an outlet pipe), *V*$_u$ is the total volume of impervious runoff, and V$_n$ is the volume estimated to become streamflow from an equivalent area in a forested catchment [@zhang_etal_2001]. This objective is of least direct ecological importance, but we emphasize it because addressing the large increase in runoff volume was central to achieving the other objectives [@walsh_etal_2012]. 


### S2. Impervious surface mapping methods

<!-- More detailed description of imperviousness determination and comparison with past estimates can be found in
wergSpatial/Projects/LSC/experimentalData/treatmentEffectStats.Rmd (and its knitted pdf and docx versions). This 
description is based on that document.-->

A. Semi-automated classification  

We used  a rule-based expert classification routine [@kunapo_etal_2005] with spatial integration and aggregation to extract three classes of impervious surface (roofs, roads and paved surfaces) and two pervious classes (tree canopy and ground pervious surfaces: Fig. S`r fig_no`). Primary data sources were LiDAR point data [source], Infra-red imagery [source], waterbodies polygon layer [source], cadastre [source], road centreline data [source], and planning-zone data [source]. We derived ground and non-ground polygons from the LiDAR, and used a normalised vegetation index (NDVI) model [@carlson_ripley_1997] to distinguish roofs and trees among the non-ground polygons, and to distinguish grass from non-grass ground polygons.  

The non-grass ground polygons were further screened by excluding areas classed as waterbodies. To detect roads obscured by tree cover, we used the cadastre to derive road-reserve parcels.  Within road-reserve parcels, we augmented road polygons with a buffer of width determined by street type to road centre-lines. Driveway surfaces obscured by tree canopy were manually added by inspection of the aerial photos in areas with tree cover.  Polygons were Polygons were split on parcel boundaries (See S3) and given parcel identifiers to permit parcel-wise estimates of impervious cover. We applied this method to the entire Melbourne Water area covering an area of 1,278 km2.  For this study, we report only on the areas within our study catchments.  


```{r eval=FALSE, echo=FALSE, fig.width = 7, fig.height = 5}

DiagrammeR::grViz("digraph rmarkdown{
  graph [rankdir = TB]
  node [fontname = Helvetica, fontsize = 36,shape = box]
  tab1 [label = '@@1']
  tab2 [label = '@@2']
  tab3 [label = '@@3']
  tab4 [label = '@@4']
  tab5 [label = '@@5', color = 'red']
  tab6 [label = '@@6']
  tab7 [label = '@@7']
  tab8 [label = '@@8']
  tab9 [label = '@@9']
  tab10 [label = '@@10']
  tab11 [label = '@@11', color = 'red']
  tab12 [label = '@@12', color = 'red']
  
  tab1 -> tab2 -> tab3;
  tab4 -> tab5 -> tab6;
  tab4 -> tab7 -> tab8;
  tab2 -> tab5;
  tab2 -> tab6;
  tab3 -> tab7;
  tab3 -> tab8;
  tab8 -> tab9 -> tab10 -> tab11 
  tab10 -> tab12;
}
  
  [1]: paste0('1. LiDAR height model', '\\n ', '(non-ground minus ground data)')
  [2]: paste0('1.1. Develop a non-ground', '\\n ', 'polygon layer for height >1.5 m')   
  [3]: paste0('1.2. Develop a ground polygon layer', '\\n ', 'by removing non-ground polygons', '\\n ','from the study area polygons')      
  [4]: paste0('2. NDVI model', '\\n ', '([infrared - red]/[infrared + red]) * 100')
  [5]: paste0('2.1. Roofs: select NDVI ', '\u2264 20', '\\n ', 'within non-ground polygon.', '\\n ', 'Perform QA and finalise roofs layer')   
  [6]: paste0('2.2. Trees: Remove roofs from ', '\\n ', 'non-ground polygons to form', '\\n ','a tree layer')      
  [7]: paste0('2.3 Grass: select NDVI >20', '\\n ', 'within ground polygon')
  [8]: paste0('2.4. Other: remove grass from ground', '\u2264 20', '\\n ', 'polygons to form other areas.', '\\n ', '(paving, bare soils, unsealed roads, water)') 
  [9]: paste0('3.1. Use waterbodies polygon layer to', '\\n ', 'remove waterbodies from other')
  [10]: paste0('3.2. Use cadastre to split all', '\\n ', 'ground polygons into road and property parcels')
  [11]: paste0('3.3. Use road type classes from', '\\n ', 'centreline data to separate unsealed', '\\n ', 'roads in road polygons to form roads layer')
  [12]: paste0('3.4. Use planning scheme zone data', '\\n ', 'to identify properties likely to have', '\\n ', 'paved ground surfaces, remove bare soil', '\\n ', 'from other to form paved impervious layer')
  ")
```
```{r, include=TRUE, fig.align="center", echo=FALSE, fig.width = 6.75, fig.height = 5}
#flow chart generated in above chunk in Rstudio, and printed to pdf.
knitr::include_graphics("images/imp_determination_flow_diag.pdf")
```

#### Fig. S-`r fig_no`. Process flow diagram for semi-automated determination of polygon layers for the three classes of impervious surface (red boxes).    

B.	Manual validation and correction  

We used the semi-automated data as a base dataset to derive a final corrected impervious dataset.  We used the series of nearmap.com aerial images from 2009 to 2017 (www.nearmap.com) to manually correct boundaries and classification (roof or paved, the latter being a combination of road and â€˜otherâ€™ in the semi-automated data) of impervious polygons in every property and road parcel of L4, D8 (and their nested subcatchments), Ly, Sa, and a 70-ha portion of the more densely developed Br. Using multiple images permitted better discrimination of surfaces in treed areas that were obscured in some images but not others, in addition to deriving construction dates of recent surfaces. 

For other catchments, Google street view was used to check and correct all road and driveway surfaces, but property surfaces were not checked. Major omissions and misclassifications in Fe and Ol were corrected, but paved surfaces on properties were not corrected.  For areas that were not completely corrected, correction factors were applied to imperviousness estimates based on similar checked areas (see the code below).  

The available time series of images (2000, 2004, and nearmap imagery from 2009 to 2017 at 1-6 mo intervals) were used to estimate dates of constructions or demolitions of impervious surfaces were noted for relevant polygons in all parcels in L4, D4, D8, Ly, Sa, and portions of Fe, Ol, and Br.  These data were used to construct time-series of growth in impervious area in the first 5 catchments, and similar time series were estimated for the last 3 by applying growth rates of areas of similar development to the 2009 estimates of impervious area in the areas that had not been systematically checked at the parcel level. The code in 'load_ld_scms_tables.R' builds a data frame of TI and EI time series for each of the eleven study catchments, from construction date data in the parcelChanges table in the SCMs database (see S3) for the 6 experimental catchments (L1, Ln, Ls, L4, D4 and D8), and from a combination of construction date data in the catIA table and application of growth factors.

The code in 'load_ld_scms_tables.R' (sourced in compiling this document) records the process used to compile TI and EI time series for eleven catchments into a data.frame called `ei_ts`.



