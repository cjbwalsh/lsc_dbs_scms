---
title: 'Linking Stormwater Control Performance to Stream Ecosystem Outcomes: Incorporating Performance Metrics into Effective Imperviousness'
subtitle: 'Supplementary material S3: Stormwater control measure spatial database'
author: 'Christopher J. Walsh, Matthew J. Burns, Tim D. Fletcher, Darren G. Bos, Peter Poelsma, Joshphar Kunapo and Sam J. Imberger'
date: 'School of Ecosystem and Forest Sciences, The University of Melbourne, 500 Yarra Boulevard, Burnley Victoria 3121, Australia '
output:
  word_document:
    reference_docx: myStyle_double.docx
csl: water-resources-research.csl
bibliography: references.bib
---
### Equations and Figures
=======

### Figure captions  

Fig. 1.  Examples of stream ecosystem response variables as a function of effective imperviousness (EI) as piecewise regressions (solid black line with 95% confidence intervals in the grey polygon as derived by @walsh_etal_2005a, compared to a linear regression against log$_{10}$(EI + 0.001), solid red line with dotted 95% confidence limits. a) Median filterable reactive phosphorus (FRP) concentrations and b) SIGNAL score (a biotic index). Five overlapping points in a) are shown by slight jittering.

Fig. 2.  The 11 streamflow-gauging sites considered in this paper and their catchments, coloured by their status as control, experimental or reference. The 7 primary catchments of the original experiment are italicized. Impervious areas in each catchment are shaded by their connection to the stormwater drainage system. (Impervious areas outside catchments are not shown.)  Inset maps show the location of the main map (grey rectangle) in Victoria, Australia.  

Fig. 3. Time series of effective impervious (EI) variants achieved in each of the experimental catchments.  Subscripts denote variants. S1: all effective impervious areas upstream of stormwater control measures (SCMs) unweighted (assuming SCMs have no effect, S = 1). S0: all effective impervious areas upstream of SCMs set to 0 (assuming all SCMs retain stormwater perfectly). For other subscripts, 
all effective impervious surfaces upstream of SCMs are weighted by the stormwater stream impact metric (S), or one of its sub-indices, of the most downstream SCM in any train of SCMs. SF: the filtered-flow sub-metric. SR: the runoff frequency sub-metric. SV: the volume reduction sub-metric. SW: the water quality sub-metric.

Fig. 4. Values of each *EI* variant at each site at the start of the study and the range of its increase as a result of urban growth on the y-axis, and its reduction as a result of SCM implementation in experimental sites on the x-axis.  

##### page break
Table 1. 
```{r echo = FALSE}
load(here::here("data","ei_ts.rda"))
ei_fin <- rbind(tail(ei_101$iats,1),tail(ei_103$iats,1),tail(ei_53$iats,1),
                tail(ei_36$iats,1),tail(ei_74$iats,1),tail(ei_71$iats,1))
budget_fin <- rbind(tail(ei_101$budget_ts,1),tail(ei_103$budget_ts,1),tail(ei_53$budget_ts,1),
                tail(ei_36$budget_ts,1),tail(ei_74$budget_ts,1),tail(ei_71$budget_ts,1))
cat_stats <- data.frame(pipeID = c(101,103,53,36,74,71),
                        site = c("DBS0004","DBS0008","LSN0001","LSS0001","LIS0001","LIS0004"),
                        cat = c("D4","D8","Ln","Ls","L1","L4"),
                        n_scms = NA,
                        n_scm_projects = NA,
                        ei_s1 = round(100 * ei_fin$ei, 1),
                        ia_treated_ha = round(1e-4 * ei_fin$carea * (ei_fin$ei - ei_fin$s) / ei_fin$ei),
                        ia_treated_perc = round(100 * (ei_fin$ei - ei_fin$s) / ei_fin$ei,1),
                        vol_reduced_ML = round((budget_fin$V_u - budget_fin$V_m) * 1e-6),
                        vol_reduced_perc = round(100* (budget_fin$V_u - budget_fin$V_m) / budget_fin$V_u,1),
                        vol_filtered_L = round(budget_fin$F_m * 1e-6),
                        vol_filtered_perc = round(100* (budget_fin$F_m) / budget_fin$V_u,1),
                        stringsAsFactors = FALSE)
SCMs$subc <- subcs$trib[match(SCMs$pipeID,subcs$pipeID)]
scmProjects$subc <- subcs$trib[match(scmProjects$pipeID,subcs$pipeID)]
for(i in 1:6){
  allSCMs <- SCMs$scmID[SCMs$subc == cat_stats$site[i]]
  allSCMs <- allSCMs[!allSCMs %in% scmsDecommissioned$scmID]
  cat_stats$n_scms[i] <- length(allSCMs)
  cat_stats$n_scm_projects[i] <- length(scmProjects$projectID[scmProjects$subc == cat_stats$site[i]])
}
cat_stats$n_scms[cat_stats$cat == "D8"] <- sum(cat_stats$n_scms[cat_stats$cat %in% c("D4","D8")])
cat_stats$n_scm_projects[cat_stats$cat == "D8"] <- sum(cat_stats$n_scm_projects[cat_stats$cat %in% c("D4","D8")])
cat_stats$n_scms[cat_stats$cat == "L4"] <- sum(cat_stats$n_scms[cat_stats$cat %in% c("L4","L1","Ln","Ls")])
cat_stats$n_scm_projects[cat_stats$cat == "L4"] <- sum(cat_stats$n_scm_projects[cat_stats$cat %in% c("L4","L1","Ln","Ls")])

table_for_word(cat_stats, pgwidth = 6.69)
```
##### page break


```{r loadData, include = FALSE, warning=FALSE, message=FALSE}
requiredPackages <- c("RPostgreSQL","sf","lubridate","mcr","RColorBrewer",
                      "httr","rjson","scales","dplyr","here","RPostgreSQL",
                      "data.table","RMySQL")
lapply(requiredPackages, require, character.only = TRUE)
source(here("code","download.OSF.file.R"))
source(here("code","BACRIfunctions.R"))  
knitr::opts_chunk$set(echo = FALSE, dev = "pdf")
#Check all gpkg files have been downloaded to the data file, and download any that are missing.
source(here("load_ld_scms_tables.R"))
```

```{r frp_v_ei, warning=FALSE, message=FALSE, fig.width = 7.48, fig.height = 3.5}
#pdf("Fig1_frp_signal.pdf", width = 7.48, height = 3.5)
layout(matrix(c(1,2,3,3), 2, 2, byrow = TRUE), heights = c(10,1), widths = c(10,10))
par(mar = c(2,4,1,1))
#data used by Walsh et al 2005 taken from "SUSE NABS issue/FRP stats/data.txt"
# and "SUSE NABS issue/EPTE/data.txt"
 lFRP50 <- c(-1.56864E+00, -2.22185E+00, -2.09691E+00, -2.22185E+00, -2.52288E+00, -1.88606E+00, -2.04576E+00, -2.52288E+00, -2.52288E+00, -2.69897E+00, -2.00000E+00, -2.39794E+00, -1.92082E+00, -1.92082E+00)
 EI <- c(1.95167E-01, 4.26416E-03, 3.62570E-02, 4.19733E-03, 0.00000E+00, 9.52280E-02, 4.63966E-01, 0.00000E+00, 0.00000E+00, 1.16397E-03, 1.03733E-02, 6.65377E-03, 3.82980E-01, 5.47130E-02)
 #jitter to reveal overlapping points - first element of multiplier is axis range
 jittery <- c(0,-0.05,0,0.05,-0.1,0,0,0,0.1,0,0,0,0,0) * 1.5 * 0.05
 jitterx <- c(0,0,0,0,-0.05,0,0,0.05,-0.05,0,0,0,0,0) * 2.6 * 0.05
 xgon <- seq(0,0.4,0.001)
 y <- -2.6 + 57*xgon
 y[y > -2] <- -2
 plot(log10(xgon +0.001),y, typ = 'n',
      xlim = c(-3,-0.39), ylim = c(-3,-1.5), axes = FALSE,
      xlab = "", ylab = "")
 yupper <- -2.3 + 490*xgon
 yupper[yupper > -1.8] <- -1.8
 ylower <- -2.8 + 13*xgon
 ylower[ylower > -2.1] <- -2.1
 polygon(c(log10(xgon +0.001),rev(log10(xgon +0.001))),
         c(yupper,rev(ylower)), col = gray(0.75), border = gray(0.75))
 lines(log10(xgon + 0.001),y)
 axis(1, at = c(-3.5,log10(c(0,0.003,0.01,0.03,0.1,0.3)+0.001)),
                labels = c("",c(0,0.003,0.01,0.03,0.1,0.3)))
 axis(2, at = log10(c(0.0001,0.001,0.003,0.01,0.03,0.1,0.3,1,3,10,30)),
      lab = c("",0.001,0.003,0.01,0.03,0.1,0.3,"1.0","3.0",10,30), las = 1)
 title(ylab = "Median FRP (mg/L)")
 points(log10(EI +0.001) + jitterx,
        lFRP50 + jittery, pch = 21, bg = gray(0.5))
 lY <- log10(EI +0.001)
 linmod <- lm(lFRP50 ~ lY)
 newdata <-  data.frame(lY = log10(c(0.0001,0.001,0.003,0.01,0.03,0.1,0.3,1,3,10,40)))
 abline(linmod, lty = 1, col = "red")
 linmodCLs <- predict(linmod, newdata, interval = "predict")
# note this tutorial says that the default interval = predict returns the 95% confidence limits.
 matplot(as.vector(newdata["lY"]),linmodCLs[,2:3], type = 'l', col = "red", lty = 3, add = TRUE)
  title(main = "a.", adj = 0)

 sigE=c(5.29000E+00, 4.32000E+00, 6.73000E+00, 5.61000E+00, 6.35000E+00, 6.79000E+00, 4.72000E+00, 4.82000E+00, 6.47000E+00, 6.42000E+00, 6.71000E+00, 6.12000E+00, 6.88000E+00, 4.00000E+00, 5.05000E+00) 
EI_sig <- c(3.87607E-02, 1.95167E-01, 4.26416E-03, 3.62570E-02, 4.19733E-03, 0.00000E+00, 9.52280E-02, 4.63966E-01, 0.00000E+00, 0.00000E+00, 1.16397E-03, 1.03733E-02, 6.65377E-03, 3.82980E-01, 5.47130E-02)
 
 plot(log10(EI_sig +0.001),sigE, typ = 'n',
      xlim = c(-3,-0.39), ylim = c(3,8), axes = FALSE,
      xlab = "", ylab = "")
 axis(1, at = c(-3.5,log10(c(0,0.003,0.01,0.03,0.1,0.3)+0.001)),
                labels = c("",c(0,0.003,0.01,0.03,0.1,0.3)))
 axis(2, at = 1:9, las = 1)
 title(ylab = "SIGNAL score")

 y <- 6.7 - 31*xgon
 y[y < 4.5] <- 4.5
 yupper <- 6.9 - 21*xgon
 yupper[yupper < 4.7] <- 4.7
 ylower <- 6.5 - 40*xgon
 ylower[ylower < 4.2] <- 4.2
 polygon(c(log10(xgon +0.001),rev(log10(xgon +0.001))),
         c(yupper,rev(ylower)), col = gray(0.75), border = gray(0.75))
 lines(log10(xgon + 0.001),y)
 
 points(log10(EI_sig +0.001),
        sigE, pch = 21, bg = gray(0.5))
 lY <- log10(EI_sig +0.001)
 linmod <- lm(sigE ~ lY)
 newdata <-  data.frame(lY = log10(c(0.0001,0.001,0.003,0.01,0.03,0.1,0.3,1,3,10,40)))
 abline(linmod, lty = 1, col = "red")
 linmodCLs <- predict(linmod, newdata, interval = "predict")
 matplot(as.vector(newdata["lY"]),linmodCLs[,2:3], type = 'l', col = "red", lty = 3, add = TRUE)
 title(main = "b.", adj = 0)
 par(mar = c(0,0,0,0))
 plot.new()
  title(xlab = "             Proportion effective imperviousness", line = -1)

# dev.off()
 
```
  
Fig. 1. 

```{r sitemap, warning=FALSE, message=FALSE, fig.width=7.48, fig.height=9.62, dev = "png",dpi = 300}
dpi <- 300
#png("images/fig_sitemap.png",res = dpi, width = 7.48*dpi, height = 9.62*dpi)
lo <- layout(matrix(c(1,2,1,3,1,4,1,5,1,6),5,2,byrow=TRUE),widths = c(5.75,1.25), 
       heights = c(1.25,1.25,4,1.25,1.25))
par(mar = c(0,0,0,0))
plot(catMap11$geometry, lty = 3, lwd = 0.5, border = "white")
#censored to exclude IA newer than October 2009 (i.e. 2009 IA)
plot(catIA$geometry[is.na(catIA$constructionDate) |
             (!is.na(catIA$constructionDate) &
                catIA$constructionDate < "2009-10-01")],
     col = c(gray(0.6),gray(0.85),gray(0.85))[match(catIA$conn,c(1,0,0.5))],
     border = c(gray(0.6),gray(0.85),gray(0.85))[match(catIA$conn,c(1,0,0.5))],
     lwd = 0.5, add = TRUE)
#col converts conn = 0.5 to 0 (those surfaces that would be connected if the pits weren't full)..
#only applies in Wicks subcatchment
plot(streams$geometry, col = "dodgerblue", lwd = 2, add = TRUE)
plot(catMap11$geometry, lty = 3, lwd = 2, border = catMap11$col, add = TRUE)
plot(siteMap11$geometry, pch = 21, bg = siteMap11$col, cex = 1.1, add = TRUE)
siteLabels$font[siteLabels$font == 1] <- 2 #make both normal and italic fonts bold
text(st_coordinates(siteLabels),siteLabels$sites_p, cex = 1, font = siteLabels$font)
arrows(st_coordinates(siteLabels)[siteLabels$siteLabel == "LS"][1]-200,
       st_coordinates(siteLabels)[siteLabels$siteLabel == "LS"][2],
       st_coordinates(siteMap11)[siteMap11$sitecode == "LSS0001"][1],
       st_coordinates(siteMap11)[siteMap11$sitecode == "LSS0001"][2], length = 0.05)
arrows(st_coordinates(siteLabels)[siteLabels$siteLabel == "LM"][1],
       st_coordinates(siteLabels)[siteLabels$siteLabel == "LM"][2]+100,
       st_coordinates(siteMap11)[siteMap11$sitecode == "LIS0001"][1],
       st_coordinates(siteMap11)[siteMap11$sitecode == "LIS0001"][2], length = 0.05)
arrows(st_coordinates(siteLabels)[siteLabels$siteLabel == "LN"][1],
       st_coordinates(siteLabels)[siteLabels$siteLabel == "LN"][2]-100,
       st_coordinates(siteMap11)[siteMap11$sitecode == "LSN0001"][1],
       st_coordinates(siteMap11)[siteMap11$sitecode == "LSN0001"][2], length = 0.05)
raster::scalebar(2000, xy = c(355500,5801500), label= "2 km")
rng <- par("usr")
rngdat <- data.frame(x1 = rng[1], x2 = rng[2], y1 = rng[3], y2 = rng[4])
box()
plot.new()
legend("center", lty = c(3,3,3), lwd = c(2,2,2), 
       col = c(RColorBrewer::brewer.pal(3,"Dark2")), title = "Catchments",
       legend = c("Control","Experimental","Reference"), text.col = "white")
legend("center", pch = 21, pt.bg = c(RColorBrewer::brewer.pal(3,"Dark2")),
       title = "Catchments",
       legend = c("Reference","Experimental","Control"), bty = 'n')
plot.new()
legend("center", 
       pch = 15, pt.cex = 1., col = c(gray(0.6),gray(0.85)),
       legend = c("Connected","Unconnected"), title = "Impervious areas")
rngPoly <- st_sfc(st_polygon(list(rbind(rng[c(1,3)], rng[c(1,4)], rng[c(2,4)], 
                                 rng[c(2,3)],rng[c(1,3)]))))
rngPoly <- st_sf(a = 1, geom = rngPoly)
st_crs(rngPoly) <- 28355
rngPoly <- rngPoly %>% st_transform(4283)
plot.new()
plot(Australia_GDA94_GCS$geometry)
plot(Victoria_GDA94_GCS$geometry, col = "white", add = TRUE)
polygon(c(143.5,146.5,146.5,143.5),c(-36.5,-36.5,-39.1,-39.1), col = scales::alpha(gray(0.5),0.5))
plot(rngPoly$geom, col = "black", add = TRUE)
title(main = "Australia", adj = 0, font.main = 1, line = -1)
box()
par(mar =c(0,0,0,0))
bounds <- st_sfc(st_point(c(143.5,-36.5)), st_point(c(146.5,-39.1)),crs=4283)
plot(bounds, col = "white")
plot(Victoria_GDA94_GCS$geometry, add = TRUE)
plot(rngPoly$geom, col = scales::alpha(gray(0.5),0.5), add = TRUE)
title(main = "Central Victoria ", adj = 1, font.main = 1, line = -1)
box()
#dev.off()
```
  
Fig. 2.  

```{r MonitoringSiteTrendsA, results="hide", warning = FALSE, echo = FALSE, fig.width = 7, fig.height = 4, fig.cap = "Time series of effective impervious variants achieved in each of the four LSC catchments."}
layout(matrix(c(1,2,3,4,1,5,6,7,0,8,8,8),3,4,byrow = TRUE),heights= c(10,10,1),widths = c(1,10,10,10))
par(mar = c(0,0,0,0))
plot.new()
title(ylab = expression(paste("Effective imperviousness variant (%)"), sep = ""), line = -1.5, cex.lab = 1.5)
par(mar = c(2,3,1,1))
plotlEItrends(ei_101$iats, xlab = FALSE, cex.axis = 1.25)
title(main = "A. D4", adj = 0) # ,font.main = 1, cex.main = 0.9)
plotlEItrends(ei_103$iats, xlab = FALSE, ylab = FALSE)
title(main = "B. D8", adj = 0) # , font.main = 1, cex.main = 0.9)
plotlEItrends(ei_53$iats, xlab = FALSE, ylab = FALSE)
title(main = "C. Ln", adj = 0) # , font.main = 1, cex.main = 0.9)
plotlEItrends(ei_74$iats, cex.axis = 1.25)
title(main = "D. L1", adj = 0) # , font.main = 1, cex.main = 0.9)
legend("bottomright",legend = c(expression(EI[S1]),expression(EI[S]),
                                expression(EI[SF]),expression(EI[SR]),
                                expression(EI[SV]),expression(EI[SW]),expression(EI[S0])),
       lty = c(2,1,1,1,1,1,3), col = c("black",RColorBrewer::brewer.pal(7,"Set1")[c(1:5,7)]), lwd = c(2,1,1,1,1,1,1))
plotlEItrends(ei_36$iats, ylab = FALSE, cex.axis = 1.25)
title(main = "E. Ls", adj = 0) # , font.main = 1, cex.main = 0.9)
plotlEItrends(ei_71$iats, ylab = FALSE, cex.axis = 1.25)
title(main = "F. L4", adj = 0) # , font.main = 1, cex.main = 0.9)
par(mar = c(0,0,0,0))
plot.new()
title(xlab = "Date", line = -0.85, cex.lab = 1.5)
```
  
Fig. 3.  

