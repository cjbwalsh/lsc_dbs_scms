---
title: 'Linking stormwater control performance to stream ecosystem outcomes: incorporating performance metrics into effective imperviousness'
subtitle: 'Supplementary material S1, S2, S3, S4'
author: 'Christopher J. Walsh, Matthew J. Burns, Tim D. Fletcher, Darren G. Bos, Peter Poelsma, Joshphar Kunapo and Sam J. Imberger'
date: 'School of Ecosystem and Forest Sciences, The University of Melbourne, 500 Yarra Boulevard, Burnley Victoria 3121, Australia '
output: 
  word_document:
    reference_docx: officedown_template.docx
csl: water-resources-research.csl
bibliography: references.bib
---

```{r load_data, include = FALSE}
knitr::opts_chunk$set(echo = TRUE, dev = "pdf", message=FALSE) #,dpi = 200 
source("code/BACRIfunctions.R")  
# also loads required packages(scales, dplyr, lubridate, sf, here, RPostgreSQL,
#                              mcr, RColorBrewer, data.table, RMySQL,"DiagrammeR")
source("code/download.OSF.file.R")
# also loads required packages (httr rjson, here)
source("load_ld_scms_tables.R")
# this script downloads data files from the OSF repository to the local directory
example_pipeID <- 29 # used in S3
fig_no <- 1          # used throughout to number figures.
```

## Contents of this file  

Text S1 to S4  

Figures S1 to S11  

Tables S1 to S2   


## Introduction  

This supplementary information describes detailed methods used for estimating stormwater control performance and effective imperviousness, using a long-term catchment-scale experiment in Melbourne, Australia.  

The data used in the paper were structured as a postgreSQL database. The database's constituent tables are stored in an Open Science Framework repository [@walsh_etal_2021; (https://osf.io/57azq/)]. Spatial tables are stored in the spatial_data component of the repository, and non-spatial tables are stored in the linked data directory of the github repository https://github.com/cjbwalsh/lsc_dbs_scms.  The repository also holds the Rmarkdown document used to construct this document. The code in that document assumes it is running from a clone of that repository.

S1 describes the derivation and formulation of the stream stormwater impact metric and its sub-metrics in detail.  

S2 describes the methods to estimate imperviousness in the eleven study catchments. 

S3 describes compilation of specification data for stormwater control measures (SCMs) that were implemented in the Little Stringybark Creek and Dobsons Creek catchments. 

S4 describes calculation of EI and water fluxes in study subcatchments.  

##### page break  

### S1. Derivation and Formulaton of the stream stormwater impact metric, S

The stream stormwater impact metric, *S*, estimates the extent to which an SCM approximates uncontrolled stormwater flows (at its maximum value, 1)
and the extent to which it mimics the catchment hydrology and water quality of appropriate reference streams that support good ecological condition (at its minimum value, 0).  It is the mean of four sub-metrics of different aspects of hydrology that can be addressed through SCM design and that have been posited as the primary drivers of stream degradation by urban stormwater runoff [@fletcher_etal_2011; @walsh_etal_2015; @walsh_etal_2016a].  To calculate each sub-metric, a hydrologic index (*I*) for the impervious area draining to the SCM is modelled (using an average year of rainfall data, in this case 1965-1966) in three potential states:  

- *u*: the impervious area conventionally drained with no SCM;  

- *m*: the impervious area draining to the SCM, modelled based on its specifications;  

- *n*: the area covered by impervious surfaces in its pre-urban state, inferred from the runoff behaviour of forested reference catchments  

Within bounds described below, each sub-metric is the ratio of the divergence of *I* from the pre-urban state with the SCM in place and the divergence of *I* from the pre-urban state if the SCM was absent, thus scaling the effect of the SCM between best case (target or reference condition) and worst case (no stormwater control). Thus:


$$
\begin{aligned}
S_I = \frac{I_m - I_n}{I_u - I_n}
\end{aligned}
$$
where $S_I$ is the sub-metric of *S* based on the hydrologic index *I*, and the three values of *I* denoted by subscripts for three potential states as described above.  Each of the four sub-metrics assess performance against a design objective:  

1. The runoff-frequency sub-metric, $S_R$, assesses performance against a design objective to reduce the frequency and magnitude of polluted high flows from impervious surfaces by ensuring that SCMs have sufficient retention capacity to avoid overflow of untreated water in ∼95% of rain events [@walsh_etal_2009]. We used a slightly different calculation of $S_R$ from Walsh *et al.* [-@walsh_etal_2009; -@walsh_etal_2015].  The original calculation counted overflow days binarily, so that an overflow of a small fraction of a rain event was treated equally to an overflow of an entire rain event.  The new formulation weights each overflow day by the proportion of impervious runoff captured by the SCM on that day.  

$$
\begin{aligned}
S_{R} = max(\frac{R_m - R_n}{R_u - R_n}, 0)
\end{aligned}
$$
  
where *S* is the number of overflow days in an average year, with subscripts as described above.  $S_m$ was calculated as $\Sigma_i^n\frac{Vo_i}{Vu_i}$, where $Vo_i$ is the volume of overflow from the SCM on day *i*, and $Vu_i$ is the volume of impervious runoff generated by the impervious surfaces draining to the SCM on day *i*.  If the SCM overflows less frequently than the frequency of overland flow inferred for reference catchments, $S_R$ is zero.

2. The filtered-flow volume sub-metric, $S_F$, assesses performance against a design objective to restore base flows lost by the construction of impervious surfaces [@hamel_etal_2013], calculated as:  

$$
\begin{aligned}
if(F_m < F_{forest}),\:S_{F} = \frac{F_m}{F_{forest}}
\end{aligned}
$$
$$
\begin{aligned}
if(F_m > F_{pasture}),\:S_{F} = min(\frac{F_m-F_{pasture}}{F_{forest}},1)
\end{aligned}
$$
$$
\begin{aligned}
else,\:S_{F} =  0 
\end{aligned}
$$

Where $F_m$ is the filtered volume through the SCM, and $F_{pasture}$ and $F_{forest}$ are volumes inferred to be pre-urban baseflow volumes for pasture and forest land cover [@zhang_etal_2001].  These equations do not include $F_u$, which is zero because impervious surfaces prevent infiltration.

3. The water-quality sub-metric, $S_W$, assesses performance against a design objective to ensure that median concentration of primary pollutants (Total P, TP; Total N, TN; and Total Suspended Solids, TSS) flowing out of the SCM meet appropriate water quality objectives for stream protection. It was calculated as the mean of three sub-sub-metrics, calculate for each pollutant as: 

$$
\begin{aligned}
S_W = max(\frac{[X]_m - [X]_n}{[X]_u - [X]_n}),0) 
\end{aligned}
$$
where $[X]$ is the median concentration of total phosphorus (TP), total nitrogen (TN) or total suspended solids (TSS), with subscripts as described above. 
$[X]_u$ is the median concentration in untreated urban stormwater as assumed by a standard stormwater model [@ewater_2013; @duncan_1999: 0.35, 2.2 and 120 mg/L for TP, TN and TSS respectively].  $[X]_m$ is the median concentration of combined outflows and overflows from the SCM, assuming no treatment for overflows, and set reductions in median concentrations for filtration systems of differing specifications (https://urbanstreams.net/lsc/EBcalctech.html). $[X]_n$, target concentrations, were derived primarily from the median concentrations observed in reference streams (C J Walsh, unpublished data):  
 
  - 20 mg/L TSS;  

  - median concentration in reference streams was 0.03 mg/L TP, but $[TP]_n$ was set at 0.05 mg/L, the minimum median concentration achievable by biofiltration systems [@bratieres_etal_2008; @hatt_etal_2009];  

  - median concentration in the reference stream with fewest septic tanks was 0.8 mg/L TN, but $[TN]_n$ was set at 0.6 mg/L because reference sites in our study area are likely to have elevated TN concentrations, and 0.6 mg/L was achievable by biofiltration systems [@bratieres_etal_2008; @hatt_etal_2009]).

4. The volume-reduction sub-metric, $S_V$, assesses performance against a design objective to ensure that total runoff volume approximates the volume of rain falling on the impervious area that would have become streamflow in its pre-urban state.  


$$
\begin{aligned}
S_V = max(\frac{V_m - V_n}{V_u - V_n}, 0)
\end{aligned}
$$
where *V* is the total runoff volume, and following the conventions above; *V*$_m$ is the volume of impervious runoff passing through the SCM that is likely to become streamflow (overflow, exfiltration, and any flow through an outlet pipe), *V*$_u$ is the total volume of impervious runoff, and V$_n$ is the volume estimated to become streamflow from an equivalent area in a forested catchment [@zhang_etal_2001]. This objective is of least direct ecological importance, but we emphasize it because addressing the large increase in runoff volume was central to achieving the other objectives [@walsh_etal_2012]. 

##### page break  

### S2. Impervious surface mapping methods

<!-- More detailed description of imperviousness determination and comparison with past estimates can be found in
wergSpatial/Projects/LSC/experimentalData/treatmentEffectStats.Rmd (and its knitted pdf and docx versions). This 
description is based on that document.-->

A. Semi-automated classification  

We used  a rule-based expert classification routine [@kunapo_etal_2005] with spatial integration and aggregation to extract three classes of impervious surface (roofs, roads and paved surfaces) and two pervious classes (tree canopy and ground pervious surfaces: Fig. S`r fig_no`). Primary data sources were LiDAR point data and Infra-red imagery (both from Victorian Department of Sustainability and Environment 2008 Greater Melbourne LiDAR dataset, unpublished), waterbodies polygon layer [source], cadastre (https://discover.data.vic.gov.au/dataset/parcel-view-vicmap-property), road centreline data (https://discover.data.vic.gov.au/dataset/vicmap-transport-road-network), and planning-zone data (https://discover.data.vic.gov.au/dataset/planning-scheme-zones-vicmap-planning). We derived ground and non-ground polygons from the LiDAR, and used a normalised vegetation index (NDVI) model [@carlson_ripley_1997] to distinguish roofs and trees among the non-ground polygons, and to distinguish grass from non-grass ground polygons.  

The non-grass ground polygons were further screened by excluding areas classed as waterbodies. To detect roads obscured by tree cover, we used the cadastre to derive road-reserve parcels.  Within road-reserve parcels, we augmented road polygons with a buffer of width determined by street type to road centre-lines. Driveway surfaces obscured by tree canopy were manually added by inspection of the aerial photos in areas with tree cover.  Polygons were Polygons were split on parcel boundaries (See S3) and given parcel identifiers to permit parcel-wise estimates of impervious cover. We applied this method to the entire Melbourne Water area covering an area of 1,278 km^2^.  For this study, we report only on the areas within our study catchments.  


```{r eval=FALSE, echo=FALSE, fig.width = 7, fig.height = 5}
DiagrammeR::grViz("digraph rmarkdown{
  graph [rankdir = TB]
  node [fontname = Helvetica, fontsize = 36,shape = box]
  tab1 [label = '@@1']
  tab2 [label = '@@2']
  tab3 [label = '@@3']
  tab4 [label = '@@4']
  tab5 [label = '@@5', color = 'red']
  tab6 [label = '@@6']
  tab7 [label = '@@7']
  tab8 [label = '@@8']
  tab9 [label = '@@9']
  tab10 [label = '@@10']
  tab11 [label = '@@11', color = 'red']
  tab12 [label = '@@12', color = 'red']
  
  tab1 -> tab2 -> tab3;
  tab4 -> tab5 -> tab6;
  tab4 -> tab7 -> tab8;
  tab2 -> tab5;
  tab2 -> tab6;
  tab3 -> tab7;
  tab3 -> tab8;
  tab8 -> tab9 -> tab10 -> tab11 
  tab10 -> tab12;
}
  
  [1]: paste0('1. LiDAR height model', '\\n ', '(non-ground minus ground data)')
  [2]: paste0('1.1. Develop a non-ground', '\\n ', 'polygon layer for height >1.5 m')   
  [3]: paste0('1.2. Develop a ground polygon layer', '\\n ', 'by removing non-ground polygons', '\\n ','from the study area polygons')      
  [4]: paste0('2. NDVI model', '\\n ', '([infrared - red]/[infrared + red]) * 100')
  [5]: paste0('2.1. Roofs: select NDVI ', '\u2264 20', '\\n ', 'within non-ground polygon.', '\\n ', 'Perform QA and finalise roofs layer')   
  [6]: paste0('2.2. Trees: Remove roofs from ', '\\n ', 'non-ground polygons to form', '\\n ','a tree layer')      
  [7]: paste0('2.3 Grass: select NDVI >20', '\\n ', 'within ground polygon')
  [8]: paste0('2.4. Other: remove grass from ground', '\u2264 20', '\\n ', 'polygons to form other areas.', '\\n ', '(paving, bare soils, unsealed roads, water)') 
  [9]: paste0('3.1. Use waterbodies polygon layer to', '\\n ', 'remove waterbodies from other')
  [10]: paste0('3.2. Use cadastre to split all', '\\n ', 'ground polygons into road and property parcels')
  [11]: paste0('3.3. Use road type classes from', '\\n ', 'centreline data to separate unsealed', '\\n ', 'roads in road polygons to form roads layer')
  [12]: paste0('3.4. Use planning scheme zone data', '\\n ', 'to identify properties likely to have', '\\n ', 'paved ground surfaces, remove bare soil', '\\n ', 'from other to form paved impervious layer')
  ")
```
```{r, include=TRUE, echo=FALSE, fig.width = 6.75, fig.height = 5}
#flow chart generated in above chunk in Rstudio, and printed to pdf.
knitr::include_graphics("images/imp_determination_flow_diag.pdf")
```

#### Fig. S`r fig_no`. Process flow diagram for semi-automated determination of polygon layers for the three classes of impervious surface (red boxes).    

B.	Manual validation and correction  

We used the semi-automated data as a base dataset to derive a final corrected impervious dataset.  We used the series of nearmap.com aerial images from 2009 to 2017 (www.nearmap.com) to manually correct boundaries and classification (roof or paved, the latter being a combination of road and ‘other’ in the semi-automated data) of impervious polygons in every property and road parcel of L4, D8 (and their nested subcatchments), Ly, Sa, and a 70-ha portion of the more densely developed Br. Using multiple images permitted better discrimination of surfaces in treed areas that were obscured in some images but not others, in addition to deriving construction dates of recent surfaces. 

For other catchments, Google street view was used to check and correct all road and driveway surfaces, but property surfaces were not checked. Major omissions and misclassifications in Fe and Ol were corrected, but paved surfaces on properties were not corrected.  For areas that were not completely corrected, correction factors were applied to imperviousness estimates based on similar checked areas (see the code below).  

The available time series of images (2000, 2004, and nearmap imagery from 2009 to 2017 at 1-6 mo intervals) were used to estimate dates of constructions or demolitions of impervious surfaces were noted for relevant polygons in all parcels in L4, D4, D8, Ly, Sa, and portions of Fe, Ol, and Br.  These data were used to construct time-series of growth in impervious area in the first 5 catchments, and similar time series were estimated for the last 3 by applying growth rates of areas of similar development to the 2009 estimates of impervious area in the areas that had not been systematically checked at the parcel level. The code in 'load_ld_scms_tables.R' builds a data frame of TI and EI time series for each of the eleven study catchments, from construction date data in the parcelChanges table in the SCMs database (see S3) for the 6 experimental catchments (L1, Ln, Ls, L4, D4 and D8), and from a combination of construction date data in the catIA table and application of growth factors.

The code in 'load_ld_scms_tables.R' (sourced in compiling this document) records the process used to compile TI and EI time series for eleven catchments into a data.frame called `ei_ts`. Note that the catIA table that is used to compile time series for the reference and control catchments is not part of the database described in S3.  

##### page break  
### S3. Stormwater control measure specification and location data  

Data detailing the specifications of all SCMs in the two catchments (Little Stringybark and Dobsons) were compiled into the postgreSQL database (Fig. S`r fig_no + 1`). 

Each catchment was divided at two scales: into (property and road) parcels, and into pipe subcatchments that permit calculation of impervious runoff and fluxes of waters into and out of SCMs at the property, pipe subcatchment and catchment scale. Specifications of tanks, raingardens and downpipe diverters permit modelling of individual SCMs and treatment trains of SCMs that drain to each other.  Dates of changes in impervious coverage, in installation, decommissioning and specifications of SCMs, permit calculation of time series of fluxes at all scales.

```{r, include=TRUE, echo=FALSE, fig.width=6.75, fig.height = 3.5}
fig_no <- fig_no + 1
#ER diagram generated in dBeaver, and printed to pdf (paper size Choukei 3 envelope).
knitr::include_graphics("images/ld_scms_ER_diagram.pdf")
```

#### Fig. S`r fig_no`. Tables and their relationships in database of stormwater control measures in the Little Stringybark and Dobsons Creek catchments. Spatial tables can be identified by their geometry field.
  
  
The following description of the constituent tables explains the logic underlying the dataset and its use.  
  
```{r figS3_pipeIDmap, echo = FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.height = 4}
fig_no <- fig_no + 1
par(mar = c(0,0,0,0),mfrow = c(1,2))
plot(subcs$geometry[subcs$pipeID < 100]) #LSC pipeIDs < 100, DBS pipe IDs > 100
scCentroids <- sf::st_centroid(subcs$geometry[subcs$pipeID < 100])
plot(streams$geometry[is.na(streams$streamName) | 
                        streams$streamName %in% c("LITTLE STRINGYBARK CREEK",
                                                  "WATTLE VALLEY CREEK")], 
     col = "darkblue", add = TRUE)
plot(sites$geometry[sites$hydrology == 1], pch = 21,bg = gray(0.5), add = TRUE)
text(sf::st_coordinates(scCentroids)[,1], sf::st_coordinates(scCentroids)[,2] + 30, 
     subcs$pipeID[subcs$pipeID < 100], cex = 0.5)
text(sf::st_coordinates(scCentroids)[,1], sf::st_coordinates(scCentroids)[,2] - 30, 
     paste(subcs$nextds[subcs$pipeID < 100], sep = ""), cex = 0.5, font = 3, col = "red")
title(main = "A. Little Stringybark Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)

plot(subcs$geometry[subcs$pipeID > 100])
scCentroids <- sf::st_centroid(subcs$geometry[subcs$pipeID > 100])
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, col = "darkblue", add = TRUE))
plot(sites$geometry[sites$hydrology == 1], pch = 21,bg = gray(0.5), add = TRUE)
text(sf::st_coordinates(scCentroids)[,1], sf::st_coordinates(scCentroids)[,2] + 60, 
     subcs$pipeID[subcs$pipeID > 100], cex = 0.5)
text(sf::st_coordinates(scCentroids)[,1], sf::st_coordinates(scCentroids)[,2] - 60, 
     paste(subcs$nextds[subcs$pipeID > 100], sep = ""), cex = 0.5, font = 3, col = "red")
title(main = "B. Dobsons Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)
```
  
#### Fig. S`r fig_no`. Maps of 'pipe' subcatchments used to partition the study catchments of A. Little Stringybark Creek (LSC) and B. Dobsons Creek. The pipeID of each subcatchment is indicated in black, and the next pipeID downstream is indicated in red, italic font. The locations of the 5 LSC and 3 DBS flow gauges used in the study are indicated as gray circles.  

### Table subcs (pipe subcatchments)  

The catchments of the two most downstream experimental sites (D8 and L4) are divided into subcatchments (identified by unique pipeIDs, Fig. S3) that permit modelling of impervious runoff and SCM performance at a range of scales. Subcatchments were selected:  

1. at the outlet of pipes which are (or potentially could be) intercepted by an SCM before entering the stream;  

2. at segments along streams upstream of a pipe subcatchment outlet;  

3. at the locations of sampling reaches or gauges.  

The field "pipeName" gives meaningful names to each pipeID either by a street name, or the name of an SCM or the code for a sampling site. The field "nextds" identifies the next pipeID downstream (see Fig. S`r fig_no + 1`), allowing compilation of all upstream pipeIDs using the function allupstream(). "scarea" is the area of the subcatchment polygon in m^2^, and "carea" is the total upstream catchment area for each subcatchment (also in m^2^).  "trib" is the gauge site that the subcatchment lies in (i.e. L4, L1, Ln, Ls, D4 or D8).  
 
```{r figS4_parcelMap, echo = FALSE, warning=FALSE, message=FALSE, fig.width = 7, fig.height = 4}
fig_no <- fig_no + 1
par(mar = c(0,0,0,0),mfrow = c(1,2))
plot(parcels$geometry[parcels$parcelType == "property" & parcels$pipeID < 100], border = "#fc8d62")
plot(parcels$geometry[parcels$parcelType == "road" & parcels$pipeID < 100], border = "#66c2a5", add = TRUE)
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, col = "darkblue", add = TRUE))
title(main = "A. Little Stringybark Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)

plot(parcels$geometry[parcels$parcelType == "property" & parcels$pipeID > 100], border = "#fc8d62")
plot(parcels$geometry[parcels$parcelType == "road" & parcels$pipeID > 100], border = "#66c2a5", add = TRUE)
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, col = "darkblue", add = TRUE))
title(main = "B. Dobsons Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)
```
  
#### Fig. S`r fig_no`. Maps of road (green) and property (orange) parcels of A. Little Stringybark Creek (LSC) and B. Dobsons Creek. .  

### Table parcels  

The catchments of the two most downstream experimental sites were also divided into parcels:  

- property parcels, obtained from the government cadastre (land.vic.gov.au), cut to the catchment boundaries of D8 and L4 using the intersect function in QGIS. Some manual editing of the resulting property parcel layer was required to a) combine parcels on several properties that functioned as single properties, but were mapped as multiple titles, b) split several parcels that had been recently subdivided; and c) split any property parcels that spanned two pipe subcatchments and that had impervious areas that drained to different subcatchments. The last case was rare, and restricted to some larger properties: most properties had a single point of legal discharge to which stormwater runoff was required to drain.

- road parcels, obtained using the difference function in QGIS (between the property parcel and the catchment boundary layers) to identify the road reserves of each pipe subcatchment, as the cadastre has gaps for road reserves. This extracted road reserve layer was manually split (using the split features tool) at intersections, and a unique parcelID was created for each newly created road parcel. 

Property and road parcels were combined into a single spatial table, parcels (Fig. S`r fig_no`).   
  
```{r figS5_iaMap, echo = FALSE, warning=FALSE, message=FALSE, dev = "png", dpi = 300, fig.width = 7, fig.height = 4}
fig_no <- fig_no + 1
par(mar = c(0,0,0,0),mfrow = c(1,2))
plot(cats$geometry[cats$sitecode %in% c("LIS0004H","LIS0001","LSN0001","LSS0001")])
rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = gray(0.8),border = NA)
plot(cats$geometry[cats$sitecode %in% c("LIS0004H","LIS0001","LSN0001","LSS0001")], add = TRUE)
plot(ia$geometry[ia$pipeID < 100], border = NA, 
     col = RColorBrewer::brewer.pal(3,"YlOrBr")[match(ia$conn[ia$pipeID < 100],c(0,0.5,1))], add = TRUE)
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, col = "darkblue", add = TRUE))
title(main = "A. Little Stringybark Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)

plot(cats$geometry[grep("DBS",cats$sitecode)])
rect(par("usr")[1],par("usr")[3],par("usr")[2],par("usr")[4],col = gray(0.8),border = NA)
plot(cats$geometry[grep("DBS",cats$sitecode)], add = TRUE)
plot(ia$geometry[ia$pipeID > 100], border = NA, 
     col = RColorBrewer::brewer.pal(3,"YlOrBr")[match(ia$conn[ia$pipeID > 100],c(0,0.5,1))], add = TRUE)
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, col = "darkblue", add = TRUE))
title(main = "B. Dobsons Creek", adj = 0, line = -1, font.main = 1, cex.main = 0.8)
legend("bottomright", pch = 15, col = RColorBrewer::brewer.pal(3,"YlOrBr"), legend = c(0,0.5,1), title = "Connected", cex = 0.8, bg = gray(0.8))
```
  
#### Fig. S`r fig_no`. Maps of impervious areas of A. Little Stringybark Creek (LSC) and B. Dobsons Creek, coloured by drainage connection (see text).  

### Table ia (impervious surfaces)  

Impervious polygons (see S2 for determination) were split by parcel and by pipe subcatchment to permit parcel-wise and sub-catchment-wise estimation of imperviousness. Each resulting polygon was given a unique polygon identifier (polyID), a parcel identifier (address, matched to the parcels table) and a pipeID (matched to the subcs table).  The conn field denoted drainage connection, where conn = 1 for surfaces draining to sealed stormwater drainage, 0 for surfaces that are informally drained to land.  

The field parcType indicates the type of parcel the surface lies in (property or road).  All surfaces in road parcels were paved, ground surfaces, while surfaces in property parcels could be either roof or paving.  For the LSC catchment, property surfaces were reliably classified as roof or ground paving (pave), and were classed as such in the surfType field.  In other catchments, the classification of roof and paving in properties was unreliable, and all property surfaces were classed as roof.

The contructionDate field was empty for most surfaces, but the construction date was entered for any surfaces for which construction was evident in the time series of aerial imagery.  Dates were inferred to the nearest month based on the progress of construction visible in the photos.  The area of each surface was calculated in R using the package sf and recorded in the field area_m2.  

### Table parcelChanges  

For all impervious polygons in table ia that were constructed, demolished or connected to the drainage system during the study period, the date of change was recorded in the date field of parcelChanges together with "polyID" (matched to table ia), "pipeID" (matched to table subcs), "address" and "parcelID" (both matched to table parcels), and "changeType" (construction, demolition or connection).  The connection status ("conn"), surface type ("surfType":roof or pave), and any further details ("comment") were also noted.  

### Table scmProjects  

The `r dim(scmProjects)[1]` stormwater control projects in the two experimental catchments, identified by a unique "projectID", were discrete, identifiable projects on a single parcel (matched to table parcels by the field "address").  Each project consisted of one or more stormwater control measures (see table SCMs below) that may overflow independently to the drainage network, or be connected to each other in a treatment train. Most projects were constructed as part of a single project with an identifiable cost. The only exception were small kerb-cut raingarden projects that were commissioned by Yarra Ranges Council in groups, often across multiple road parcels. For these projects, stormwater control measures in each project were grouped by parcel into separate projectIDs and their cost estimated proportionally. (Cost data were removed from the dataset for this paper.) Several properties had more than one project constructed over the study period.  

Each project was associated with a "round" with the following possible values:  

- 'DBS existing SCMs' or 'E', existing stormwater control projects that were installed prior to the study in the D8-e and L4-e catchments, respectively;  

- 'DBS tanks round 1', the first round of engagement in the Dobsons Creek project, funded by offering standardised stormwater treatment systems free of charge [@cheesman_etal_2016];  

- 'DBS tanks round 2', the first round of engagement in the Dobsons Creek project, funded by a reverse single round, multi-unit, sealed bid, budget constrained, discriminatory price auction, with an undisclosed reserve price [@cheesman_etal_2016];

- '1', the first round of engagement in the Little Stringybark Creek project funded by a reverse, sealed-bid uniform-price auction [@bos_brown_2015];  

- '2', the second round of engagement in the Little Stringybark Creek project funded by a reverse, rising-clock, uniform-price auction [@bos_brown_2015];  

- '3', the third round of engagement in the Little Stringybark Creek project funded by offering standardised stormwater treatment systems free of charge to properties in pipe subcatchments with no possibility of end-of-pipe SCMs, with maximum cost set by rounds 1 and 2 [@bos_brown_2015];  

- '4', an extension of the third round of engagement in the Little Stringybark Creek project;  

- 'D', demonstration projects conducted in the early stages of the Little Stringybark Creek project;  

- 'N', projects implemented during the study period independent of the project;  

- 'SO', projects implemented as a requirement of the environmental significance overlay on the Little Stringybark Creek catchment [@bos_brown_2015];  

- 'DBS KCC raingardens', stormwater control measures installed by Knox City Council as part of the Dobsons Creek project;  

- 'PN', small curb-cut stormwater control measures installed on public land by Yarra Ranges Council, funded by the same mechanism as round 3;  
 
- 'PL', large stormwater control systems on public land, mostly installed and operated by Yarra Ranges Council (one on a school property), collecting runoff from all impervious surfaces upstream of their subcatchments (identified by pipeID).  

The scmProject table lists each "projectID", "round", "installDate" (the date of installation), "pipeID" (matched to table subcs), and "parcelID" (matched to table parcels).  

### Table SCMs  

Each of the `r dim(SCMs)[1]` SCMs in the two experimental catchments is identified by a unique "scmID", and a "type" (one of 'dd', downpipe diverter; 'tank', rainwater tank; or 'rg', raingarden, in the broadest sense including infiltration systems, bioinfiltration systems, etc).  

Each SCM also has a 'nextds', which takes the value of one of:  

- NA (i.e. missing), indicating that the SCM overflows to the stormwater drainage system;  

- land', indicating that the SCM overflows informally to pervious land, thereby fully rendering the impervious surfaces upstream non-effective;  

- the "scmID" of another SCM to which the SCM overflows.  

The SCMs table also lists the fields "round" (matched to table scmProjects), "dbName" (a meaningful descriptor for some SCMs), projectID (matched to table scmProjects), pipeID (matched to table subcs), and parcelID (matched to table parcels).  The three types of SCMs have different sets of specification parameters required to model their performance, thus requiring separate specifications tables (downpipe diverters, dds; tanks and raingardens).  

### Table dds  

`r sum(dds$ddNo)` downpipe diverters were installed on `r dim(dds)[1]` properties as part of the first round of engagement in the Dobsons Creek catchment.  Diverters were of a standard design: 500-mm length of 90-mm downpipe, with a volume of ~3.2 L, attached to a standard hose at a height of ~1 m, which drains to a garden.  The design conservatively aimed to minimize the risk of downpipe-blocking in intense rain events. As a result, most diverters resulted in very small degrees of retention (< 1 mm/d of rainfall retained if the roof area draining to the diverter exceeded 10 m^2^).  Diverters were not installed in any other rounds.  

To model their performance, all diverters installed as part of a single project were given an "scmID".  For each set of diverters in a projectID, the dds table lists "scmID","projectID",the total catchment area draining to the diverters in m^2^ "ddCarea", and the number of diverters "ddNo". 

### Table tanks  

`r dim(tanks)[1] - sum(tanks$round %in% c("E","DBS existing SCMs"))` tanks were installed in the two experimental catchments during the study period, in addition to `r sum(tanks$round %in% c("E","DBS existing SCMs"))` existing tanks.  The tanks table lists the specifications required to model their performance (Table 1). 

#### Table S1. Fields and definitions for the tanks table.  

```{r tanksMetaData, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
tanksMetaData <- metadata[metadata$tab == "tanks",c("field","definition")]
names(tanksMetaData) <- c("Field","Definition")
row.names(tanksMetaData) <- NULL
table_for_word(tanksMetaData, pgwidth = 6.69)
```
 
### Table raingardens  

`r dim(raingardens)[1]` raingardens were installed in the two experimental catchments during the study.  The raingardens table lists the specifications required to model their performance (Table 2).
  

#### Table S2. Fields and definitions for the raingardens table.  

```{r rgsMetaData, echo=FALSE, message=FALSE, warning=FALSE, paged.print=FALSE}
rgsMetaData <- metadata[metadata$tab == "raingardens",c("field","definition")]
names(rgsMetaData) <- c("Field","Definition")
row.names(rgsMetaData) <- NULL
table_for_word(rgsMetaData, pgwidth = 6.69)
```

### Table scmChanges  

The specifications of `r length(unique(scmChanges$scmID))` SCMs changed during the study, and those changes are listed in this table.  For each change the scmID and projectID are listed, together with the date of the change ("changeDate").  The parameter "param" (matching a field in the relevant table, dds, tanks or raingardens), is listed together with the value of the parameter after the change, "newValue".  

### Table scmsDecommissioned  

`r dim(scmsDecommissioned)[1]` SCMs were decommissioned during the study, in almost all cases to be replaced by an upgraded system as part of one of the engagement rounds.  These SCMS are listed in this table, with the date of decommissioning "decommDate", and any explanatory information in "comments".  

### Table filtprofs  

The filtprofs table lists profiles of hydraulic conductivity measured in 12 locations around the Little Stringybark Creek catchment (Fig. S`r fig_no + 1`) and the mean, default profiles used in estimating performance in raingardens in other locations in the LSC catchment and in the Dobsons Creek catchment.  For each profile (identified by "filtprofFile"), the profile to 1-m depth was split into strata (specified by the lowest depth of each stratum, "depth_m") of different hydraulic conductivity ("Ks_mm_h").  The table also has a porosity field, but this is not used in calculations, as the specification of filter medium in modelling raingardens is used to determine porosity.

The substantial small-scale variability among the measured soil profiles made accurate prediction of soil hydraulic conductivity impossible. Following review of the variability among sites, a mean soil profile was developed as the default value for the Little Stringybark Creek catchment. This profile was used to model raingarden performance for all raingardens, except for those for which on-site measurements of hydraulic conductivity had been made (Fig. S`r fig_no + 1`).  The default used in this paper differed from earlier performance calculations [e.g. @fletcher_etal_2011], having a more gradual decline in hydraulic conductivity with depth than the original default, and a higher hydraulic conductivity at the maximum depth (0.1 mm/h vs 0.005 mm/h).  This resulted in increased estimated infiltration rates and filtered volume indices, although differences in the final estimates of performance and environmental benefit were small.  

In the Dobsons Creek catchments, the mean filter profile from multiple hydraulic conductivity tests around the Wicks bioinfiltration system [@bonneau_etal_2020] were used for all raingardens.  

```{r filtprof_map, echo=FALSE, warning = FALSE, message=FALSE, fig.width = 6,  fig.height = 8}
fig_no <- fig_no + 1
allProfiles <- unique(filtprofs$filtprofFile)
allProfiles <- c(allProfiles[-grep("Bailey",allProfiles)],allProfiles[grep("Bailey",allProfiles)])
profCols <- c(RColorBrewer::brewer.pal(8,"Paired")[-c(5)],rep(RColorBrewer::brewer.pal(9,"Set1")[9],5))
rgSCMs <- SCMs[SCMs$type == "rg",]
rgSCMs$filtr.prfile <- raingardens$filtr.prfile[match(rgSCMs$scmID,raingardens$scmID)]
rgSCMs$profCol <- profCols[match(rgSCMs$filtr.prfile, allProfiles)]
# rgSCMsMap <- LSCSCMsMap[as.vector(LSCSCMsMap$scmID) %in% rgSCMs$scmID,]
# rgSCMsMap$profCol <- rgSCMs$profCol[match(as.vector(rgSCMsMap$scmID), rgSCMs$scmID)]
lo <- layout(matrix(c(1,3:8,rep(2,7),15,9:14),3,7,byrow = TRUE),
       heights = c(3,12,3), widths = c(1,rep(2.5,6)))
#layout.show(lo)
par(mar = c(0,0,0,0))
plot.new()
title(ylab = "Depth (m)", line = -2)
plot(parcels$geometry[parcels$pipeID < 100], lty = 1, lwd = 1, border = gray(0.75))
plot(subcs$geometry[subcs$pipeID < 100], lty = 2, lwd = 2, border = "darkgreen", add = TRUE)
suppressWarnings(plot(sf::st_intersection(streams, subcs)$geometry, lty = 1, lwd = 2, col = "darkblue", add = TRUE))
# plot(ia$geometry[ia$pipeID < 100], lty = 1, lwd = 1,
#      border = c("#FFCC99","#660000")[match(ia$conn[ia$pipeID < 100],0:1)],
#      col = c(alpha("#FFCC99",0.5), alpha("#660000",0.5))[match(ia$conn[ia$pipeID < 100],0:1)], add = TRUE)
plot(rgSCMs$geometry, pch = 21, bg = rgSCMs$profCol, add = TRUE)
par(mar = c(4,2,1,1))
for(i in c(1:11,13)){  #leave out Bailey115mid2 to fit them all in the plot
  filtprof <- filtprofs[filtprofs$filtprofFile == allProfiles[i],]
plot(log10(c(filtprof$Ks_mm.h[1],filtprof$Ks_mm.h)), c(0,filtprof$depth_m), type = 's',lwd = 2,
           xlim = c(-3,3),ylim = c(1.4,0),axes = FALSE, xlab = "",ylab = "", col = profCols[min(i,8)])
points(-3,0,pch = 21, bg = profCols[min(i,8)])
axis(1,at  = (-4):3)
axis(2, at = seq(1.6,0,-0.2), las = 1)
abline(v = 0, lty = 3)
title(xlab = expression(paste(log[10],"(",K[su],"[mm/h])",sep = "")),col.main = profCols[min(i,8)])
title(main = gsub("profile","",
                  gsub(".filtprof","",gsub("filtprof.","",
                       gsub(".rdata","",tolower(allProfiles[i]))))))
}
par(mar = c(0,0,0,0))
plot.new()
title(ylab = "Depth (m)", line = -2)
```

#### Fig. S`r fig_no`. The default mean profile of soil hydraulic conductivity used for most raingardens in the Little Stringybark catchment (mtev.default, light blue dots on map), and the measured profiles used for raingardens at the measurement sites (colours of points match the profile curves).

### Hydrologic data used for SCM modelling  

The Environmental Benefit Index (EB) standard calculation used in all engagement rounds to assess the cost per EB used a standard single (average) year of data from the nearby Croydon rain gauge (No. 086234, www.bom.gov.au), 1 April 1965 to 31 March 1966.  The SCM model functions used by the EB calculator [https://tools.thewerg.unimelb.edu.au/EBcalc/, @fletcher_etal_2011] used two tables:  

- a daily series of rainfall, imprevious runoff and potential evapotranspriation used for tank calculations; and  

- a similarly structured hourly series.

We made minor modifications to original model function code (tankmodel.R and gardenmodel.R) used by the EB calculator (now in the file "code/modelfunctions2017.R"), and have simplified the storage of the Croydon 1965-66 data. The hourly table is now saved in the Rdata file "Croydon_1966_hourly_rain_runoff_et.rda", and is compiled for EB calculations into a list containing an hourly and a daily time-series table, using the function "prepare_runoff_data()".

We used the Croydon 1965-66 data to calculate series of EB and its variants.  To illustrate how change in EB over time corresponds to modelled change in water flows out of SCMs in S4, we used an hourly series (2000-2019) of rainfall and evapotranspiration data for the L4 catchment (saved as "lsc_rain_hourly.rda").  The rainfall data were aggregated from 6-min-interval areal rainfall data across the catchment estimated for the study period at 6-min intervals using a combination of 6-min (or less) data from the Melbourne Water Mt Evelyn gauge (229690A: https://www.melbournewater.com.au/water/rainfall-and-river-levels#/), four gauges that we installed installed over different periods in the catchment), ), and the BoM daily rainfall grid (http://www.bom.gov.au/climate/how/newproducts/IDCdrgrids.shtml).  

The BoM grid is computed using an optimised Barnes successive correction technique that applies a weighted averaging process to the station data, where each grid-point represents an approximately square area with sides of about 5 km (0.05°). Daily rainfall for each catchment was extracted from the nearest grid cell, and disaggregated using the temporal pattern of sub-daily rain gauge data from nearby gauges. The gridded daily totals were assumed to be a more accurate estimate of rainfall than daily totals from the nearest gauge. Daily gridded data with totals <0.2 mm were set to zero as they correspond to less than a single tip of a rain gauge.

A composite 6-min time series was generated by selecting the best quality gauge data in a sequential order of preference, using successively more distant gauges to infill missing/unreliable data in the preceding dataset. The resultant 6-min composite gauge data was then used to disaggregate the daily totals of each catchment.  

A different disaggregation approach was used depending on the available data. Each rainfall estimate was classified by the approach used as one of the following:  

- zeroTotal: The gridded daily total = 0. Every record for the day was set to zero even if the gauge data total > 0.  

- temporal: The gridded daily total > 0 and there were no missing values in the gauge data. The daily total was disaggregated using the temporal pattern of the gauge data.  

- semiTemporal: The gridded daily total > 0 and there were missing values in the gauge data, but the total gauge data was >= 70% of the gridded daily total. The daily total is disaggregated using the temporal pattern of the gauge data.  

- mid-point: The gridded daily total > 0 and a) there were missing values in the gauge data and the total gauge data was < 70% of the gridded daily total or b) gauge data = 0. The daily total was attributed to the mid-point of the rain day (i.e. 2100 h).  

Mean potential evapotranspiration across the catchment was estimated for the study period at 6-min intervals using the daily Morton’s potential evapotranspiration (PET) grid from the Scientific Information for Land Owners (SILO) database of historical climate records for Australia (https://www.longpaddock.qld.gov.au/silo/index.html). The grid was of the same spatial resolution as the BoM grid, and the daily PET value was extracted from the nearest grid cell.
Daily PET values were disaggregated to a 6-min interval using the temporal pattern of one-minute solar radiation data from BoM Station 086282 (Melbourne Airport: http://www.bom.gov.au/climate/data/oneminsolar/about-IDCJAC0022.shtml#service). The cosine of the sun’s zenith distance (i.e. the angular distance from directly overhead) was considered to be a good approximation for the distribution of ET throughout the day [@kumar_etal_2000].  

### S4. Calculation of EI and water fluxes in study subcatchments

The primary aim of our analysis was to quantify changes over time in effective imperviousness (and variants based on EB scores of SCMs) and fluxes of impervious runoff in each of the six experimental subcatchments, accounting for changes in impervious coverage and the installation and operation of SCMs in each subcatchment. Over time, effective impervious coverage varied as buildings and paving were constructed, demolished or connected to the drainage network; SCMs were installed, decommissioned or their specifications were altered; relationships between SCMs changed as SCMs in treatment trains came on line; and in two cases, when large-scale SCMs diverted runoff from an upstream subcatchment (King Street Upper, and The Entrance raingardens) relationships between subcatchments changed.  The upstream-downstream relationships between SCMs are illustrated in Fig. S`r fig_no + 1` for a point in time after all SCMs were installed, but such maps differed over the study period.

```{r FigS3-6_scmMaps, echo = FALSE, warning=FALSE, message=FALSE, dev = "png", dpi = 300, fig.width = 6.5, fig.height = 9}
#scmMap() function in BACRIFunctions.R
  #DBS catchments
fig_no <- fig_no + 1
  par(mfrow = c(3,2))
  scmMap(103, addLegend = TRUE,addSCMNetwork = FALSE, ZoomToSCMs = FALSE)
  title(main = " A.", adj =  0, line = -1)
  box()
  scmMap(103, addLegend = FALSE,addSCMNetwork = TRUE, ZoomToSCMs = TRUE)
  title(main = " B.", adj =  0, line = -1)
  box()
  
  #LSC catchments
  scmMap(71, addLegend = FALSE,addSCMNetwork = FALSE)
  title(main = " C.", adj =  0, line = -1)
  box()
  scmMap(74, addLegend = FALSE,addSCMNetwork = TRUE)
  title(main = " D.", adj =  0, line = -1)
  box()
  scmMap(53, addLegend = FALSE,addSCMNetwork = TRUE)
  title(main = " E.", adj =  0, line = -1)
  box()
  scmMap(36, addLegend = FALSE,addSCMNetwork = TRUE)
  title(main = " F.", adj =  0, line = -1)
  box()
```
 
#### Fig. S`r fig_no`. Experimental catchments showing connected and unconnected impervious areas and stormwater control measures (SCMs), and in B, D-F, connections between SCMs. A. D8-e;  B. Detail of that part of the D8-eand D4-e catchments serviced by stormwater drainage pipes draining to the stream; C. L4-e; D. L1-e; E. LN-e; F. LS-e.  

Calculation of impervious runoff fluxes and EB in each subcatchment thus required adjustment of the database tables at each time of change to portray the distribution and relationships between impervious surfaces and SCMs. A group of related functions (Fig. S`r fig_no + 1`) were thus developed to:   

a) compile database tables for a given date, 

b) identify the terminal SCMs in each subcatchment on that date (i.e. those SCMs that drained to the stormwater drainage network rather than to another SCM),  

c) calculate EB of each terminal SCM on that date, or the water budget from that date until the next change, and the  impervious area still draining directly to stormwater,  

d) compile a time series of EB or water budget for each SCM in the subcatchment

e) calculate overall subcatchment statistics by summing results for all SCMs and the untreated impervious area.  


```{r functions_diag, eval=FALSE, echo = FALSE, warning=FALSE, message=FALSE}
DiagrammeR::grViz("digraph rmarkdown {
graph[overlap = TRUE, fontsize = 10]
node [shape = box,
        fontname = Helvetica]
  tankmodel;
  gardenmodel;
  calcTankBudget;
  calcRGBudget;
  calcDDBudget;
  prepare_runoff_data;
  data_on_datex;
  data_for_scm;
  ia_ts;
  budget_scm_on_datex;
  EB_scm_on_datex;
  EB_scm_time_series;
#  EB_subc_on_datex;
  EI_subc_time_series;
  budget_scm_time_series;
  budget_subc_time_series

prepare_runoff_data -> ia_ts -> budget_subc_time_series
ia_ts -> EI_subc_time_series
data_on_datex -> budget_scm_on_datex -> EB_scm_on_datex -> EB_scm_time_series -> EI_subc_time_series
data_on_datex -> ia_ts
data_for_scm -> EB_scm_time_series
data_for_scm -> budget_scm_time_series
calcTankBudget -> budget_scm_on_datex -> budget_scm_time_series -> budget_subc_time_series
calcRGBudget -> budget_scm_on_datex
calcDDBudget -> budget_scm_on_datex
prepare_runoff_data -> calcRGBudget
prepare_runoff_data -> calcTankBudget
prepare_runoff_data -> calcDDBudget
#maybe the following not necessary...
# prepare_runoff_data -> budget_scm_on_datex
# prepare_runoff_data -> EB_scm_on_datex
# # prepare_runoff_data -> EB_subc_on_datex
# prepare_runoff_data -> budget_scm_time_series
# prepare_runoff_data -> budget_subc_time_series
gardenmodel -> calcRGBudget
tankmodel -> calcTankBudget
}")

```

```{r, out.width=7, include=TRUE, echo=FALSE, fig.width = 6.75, fig.height = 5.3}
fig_no <- fig_no + 1
#flow chart generated in above chunk in Rstudio, and printed to pdf.
knitr::include_graphics("images/functions_diag.pdf")
```

#### Fig. S`r fig_no`. Primary functions in BACRIfunctions.R (and modelfunctions2017.R in the case of tankmodel and gardenmodel) and the flow of calculations to achieve the primary outputs of budget_subc_time_series and EI_subc_time_series.  

### Example calculations

The following uses `r subcs$pipeName[subcs$pipeID == example_pipeID]` subcatchment (pipeID = `r example_pipeID`) as an example for calculating subcatchment EB, EI and water fluxes.  

`r ifelse(example_pipeID == 29,
"It is a small catchment with a mix of connected and unconnected impervious surfaces (roofs and roads), with a treatment train of tanks and raingardens on each of two properties, with all impervious surfaces draining to a series of raingardens at the bottom of the catchment before entering Little Stringybark Creek North.  This permits a nested series of examples, with and without the terminal series of raingardens (Fig. S9).",
paste("The original version of this document used pipeID 29, Wattle Valley Rd North, as a simple example.  Changing the value of example_pipeID makes the example potentially more complex. The explanatory text in this document may not fully apply to pipeID",example_pipeID))`.

```{r echo=FALSE}
fig_no <- fig_no + 1
```
```{r figS3_8, fig.width=5, fig.height=5}
scmMap(example_pipeID)  #Mapping function in BACRIfunctions.R
box()
```

#### Fig. S`r fig_no`. Map of example subcatchment (`r subcs$pipeName[subcs$pipeID == example_pipeID]`), with a black line indicating upstream-downstream relationships between SCMs. (Locations of SCMs are approximate within their correct land parcel.)

We begin by demonstrating the two primary functions for calculating time series of EI variants and water fluxes, before stepping through the sub-functions that they use in their calculations (Fig. S`r fig_no - 3`).  

Time series of EI variants and of modelled flows over the length of the study can simply be calculated and plotted using code shown below for Figs. S`r fig_no` and S`r fig_no  + 1`.  For this small catchment, the EI calculation (Fig. S`r fig_no`) took ~20 s, and the water flux calculation (Figs. S`r fig_no`) took ~90 s.  Calculations for larger sub-catchments take between 2 (L1-e) and 50 min (L4-e).   

```{r echo=FALSE}
fig_no <- fig_no + 1
```
```{r figS3_9, fig.width=6, fig.height=4}
Croydon <- prepare_runoff_data(get(load(paste(here::here("data"), 
                        "/Croydon_1966_hourly_rain_runoff_et.rda", sep = ""))))
ei_29 <- EI_subc_time_series(29)
plotlEItrends(ei_29$iats, legend = TRUE, ylab = TRUE, xlab = TRUE, cex = 0.8)
title(ylab = "Effective imperviousness variant (%)", xlab = "Date", cex.lab = 0.75)
```

#### Fig. S`r fig_no`. Time series plot of six effective impervious variants for example subcatchment (`r subcs$pipeName[subcs$pipeID == example_pipeID]`). Variant codes correspond to the EI subscripts used in the main paper.

```{r echo=FALSE}
fig_no <- fig_no + 1
```
```{r figS3_10, fig.width=7, fig.height=5, dev = "png", dpi = 300}
load(here("data","lsc_rain_hourly.rda"))
lsc_rain_hourly$runoff_mm <- lose.init(lsc_rain_hourly$rain_mm,0.256,2)
lsc_runoff <- prepare_runoff_data(lsc_rain_hourly) 
# system.time(
  budget_29 <- budget_subc_time_series(pipeID = 29, runoffData = lsc_runoff)
  #) #~ 2 min
layout(matrix(c(1,2),byrow = TRUE, 2,1), heights = c(11.5,12))
par(mar = c(2,4,1,1))
with(budget_29$daily, plot(date, ei_runoff/carea, type = 'l',
                          las = 1, ylab = "Daily runoff (mm/h)")); 
with(budget_29$daily, lines(date, ei_scm_runoff/carea, col = 'red')); title(main = "a)", adj = 0)
par(mar = c(4,4,1,1))
with(budget_29$hourly[date > "2018-01-01"], plot(date, ei_runoff/carea, type = 'l',
                           las= 1, ylab = "Hourly runoff (mm/h)", xlab = "Date")) 
with(budget_29$hourly[date > "2018-01-01"], lines(date, ei_scm_runoff/carea, col = 'red')); title(main = "b)", adj = 0)

```

#### Fig. S`r fig_no`. Time series of modelled impervious runoff from example subcatchment (`r subcs$pipeName[subcs$pipeID == example_pipeID]`): a) Daily flows over the full study period, b) Hourly flows for a detail of 1 year. Black lines show total impervious runoff and red lines show impervious runoff leaving the catchment after flowing through SCMs.  

The non-linear trend in EI (Fig. S`r fig_no - 1`) in this small catchment is because, prior to 2006, Wattle Valley Road was unsealed, and the impervious surfaces on properties of the subcatchment drained to the stream informally or along the roadside swale (and thus considered non-effective). In 2006, the road was sealed and curbed, with stormwater drainage connecting the road and houses of the subcatchment to the stream.  SCMs installed in the project progressively reduced that connection, culminating in the construction of a large raingarden at the bottom of the subcatchment in 2012, which captured runoff from all subcatchment impervious surfaces.  

Fig. S`r fig_no`a shows the models assume no impervious runoff from the subcatchment before sealing and piping of Wattle Valley Road in 2006, and a reduction in impervious runoff leaving the catchment following installation of SCMs in the subcatchmnent. Fig. S`r fig_no`a, shows that the frequency of overflow from the terminal SCMs in this subcatchment was reduced to ~12 rain events per year, which is sufficient for the runoff frequency sub-index (ESR ) to achieve a perfect score, i.e. *E~SR~* = 1 in Fig. `r fig_no`a.  Conversely, volumes exfiltrated from the terminal raingardens exceeded the target range, resulting in *S~F~* equalling 1, and *E~SF~* equalling *E~S1~*.

### Logic and use of the EI_subc_time_series and budget_subc_time_series functions

For every SCM, a budget of water fluxes is calculated using a time series of rainfall, impervious runoff and potential evapotransipiration, prepared using the `prepare_runoff_data` function (Fig. S`r fig_no - 3`): for EB calculations this series is the standard 1965-1966 Croydon rainfall year (see S3), while for budget calculations it is the observed rainfall during the period of SCM changes being modelled. The three types of SCM have separate functions for calculating budgets.  `calcRGBudget` and `calcTankBudget` adapt the `gardenmodel` and `tankmodel` functions, respectively (in modelfunctions2017.R, used by the EB calculator, https://tools.thewerg.unimelb.edu.au/EBcalc/, @fletcher_etal_2011), to permit specification parameters to be read from the database tables, "tanks" and "raingardens". `calcDDBudget` uses a simple look-up table to model the largely ineffective downpipe diverters that were installed in the Dobsons Creek catchment.  

The `budget_scm_on_datex` function calculates a time series of water fluxes (i.e. a budget) into and out of an SCM (specified by scmID) given its specifications (including inflows from upstream SCMs) on a specified date (datex).  The appropriate input data are compiled using `data_on_datex`.  This function, subsets the database data to those elements of relevance to scmID, and adjusts specifications for datex, including ensuring that the network of SCMs upstream of scmID (if any) are correctly specified through the "nextds" field of the SCMs table.  The function then uses the three `calc_..._Budget` functions as needed to calculate budgets for all upstream SCMs to ensure correct inflow into scmID, and finally calculates the budget for scmID on datex.  

The time series of the budget produced by `budget_scm_on_datex` depends on whether the output is to be used to calculate EB (and therefore EI variants) or to be used to calculate the budget for a specified time period (a decision specified by the "specs_for_EB" argument).  If EB is to be calculated, the function uses the 1-year Croydon 1965-1966 rainfall time series (and each SCM is assumed to be half-full at the start of the time series). The function `EB_scm_on_datex` takes this output and calculates EB index and its sub-indices for scmID on datex.  

If the required output is a budget, then the output budget time series matches the time series of the input runoff data, which can be of any length of at least 1 day.  This is to permit calculation of budgets in periods between changes in SCM specifications: in such cases, the starting volume of store in each SCM equals the final store volume in the previous run.  Such a series of SCM budget calculations is calculated with the function `budget_scm_time_series`.  This function uses `data_for_scm` to determine all the dates on which specifications relevant to scmID occurred, and runs `budget_scm_on_datex` in a loop for each date to build up an hourly series of flows into and out of the scm and daily time series of all elements of the water budget for the scm.  

If a time series of EB statistics is required, then `EB_scm_time_series` works through a similar process of identifying change dates of relevance and uses `EB_scm_on_datex` to calculate EB statistics on each change date.  

The `ia_ts` function is used to serve as a template output for the two `_subc_time_series` functions: a time series of total impervious area (tia) and effective impervious area (eia) for the nominated subcathment (pipeID).  

`EI_subc_time_series` and `budget_subc_time_series` both start by identifying all dates on which terminal SCMs (those SCMs with no other SCMs downstream) changed in pipeID.  For each such date, `EI_subc_time_series` calculates the EB statistics for each terminal SCM and divides each index by the maximum potential EB for that SCM (impervious area x 100) to get the EIA (effective impervious area) variant for that SCM. EIA variants for each date are calculated by summing EIA for all terminal SCMs and the subcatchment effective impervious area not treated by any SCM. EI is then calculated for each date by dividing by the subcatchment area.  The statistics for each day are added to the output from `ia_ts` (e.g. Fig. `r fig_no - 1`).  

For each change date, `budget_subc_time_series` uses `budget_scm_time_series` to calculate a time series of water fluxes from each terminal SCM for the period until the next change date. It loops through each SCM, subtracting the impervious area treated by the SCM at each time step from the eia as estimated by `ia_ts`, and adding the time series of flow components passing through each SCMs together. Once budgets for all terminal SCMs have been calculated, impervious runoff from the untreated impervious surfaces of the subcatchment is added to outflows from the SCMs to produce two flow series (total impervious runoff, ei_runoff, and impervious runoff reaching the subcatchment outlet having passed through SCMs, ei_scm_runoff, see Fig. S`r fig_no`).  


##### page break  

## References



